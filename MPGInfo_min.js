"use strict";var mpg=function(e,t,r){var i={},n={type:"uri"};r||(r=t,t=!1),"string"==typeof e?e={file:e,type:"uri"}:(e={file:e,type:"file"},i.filesize=e.file.size,i.filename=e.file.name,i.filedate=e.file.lastModifiedDate,i.speedy=t,i.mpgVers=0,i.Atracks=[],i.Vtracks=[],i.Stracks=[],i.PackHeaders=0,i.SystemHeaders=0,i.ENDPackets=0,i.PSMPackets=0,i.OthersPackets=0,i.PackHeadersSize=0,i.SystemHeadersSize=0,i.PSMPacketsSize=0,i.SCRs=[],i.SCR_tmp=[],i.SCR_deb=[],i.SCR_end=[],i.isDVD=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i.indDVD=0,i.menu=!1,i.beginend=!1,i.nbloop=5,i.countloop=0);for(var s in e)n[s]=e[s];if(!n.file)return cb("No file was set");var a={};a.parse=function(e,t){function r(e,t,r){for(var i=[],n=t;t+r>n;n++){var s=e.getUint8(n).toString(16);1==s.length&&(s="0"+s),i.push(s)}return i.join("")}function n(e,t,r){for(var i=[],n=t;t+r>n;n++)i.push(String.fromCharCode(e.getUint8(n)));return i.join("")}function s(t,r,i){e.read(t,r,function(e,t){if(e)i(e);else{var r=new DataView(t);i(null,r)}})}function a(e,t){if(r(e,t,3)==A&&e.getUint8(t+3)==S)return i.ENDPackets+=1,i.SCRs.push([s,a,d,c]),t+4;if(i.speedy&&B>0)for(;r(e,t,3)!=A||e.getUint8(t+3)!=k&&t<e.byteLength-4;)t+=1;if(r(e,t,3)==A&&e.getUint8(t+3)==k){if(i.indDVD<16&&(i.indDVD+=1,t%2048==0&&(i.isDVD[i.indDVD]=1)),t+=4,32!=(32&e.getUint8(t))&&1==i.mpgVers||64!=(64&e.getUint8(t))&&2==i.mpgVers)return 0;if(1==i.mpgVers){var s=14&e.getUint8(t);t+=1;var a=e.getUint16(t,!1)>>1,d=e.getUint16(t+2,!1)>>1,c=0;t+=4}else{var s=(56&e.getUint8(t))>>3,a=(3&e.getUint8(t))<<13;t+=1,a+=(65528&e.getUint16(t,!1))>>3;var d=(3&e.getUint16(t))<<13;d+=(65528&e.getUint16(t+2,!1))>>3;var c=(3&e.getUint16(t+2,!1))<<7;c+=(254&e.getUint8(t+5))>>1,t+=6}0==i.SCR_deb.length?i.SCR_deb=[s,a,d,c]:(i.speedy||32768*a+d<32768*i.SCR_end[1]+i.SCR_end[2]&&i.SCRs.push(i.SCR_end),i.SCR_end=[s,a,d,c]);var f=(127&e.getUint8(t))<<15;if(f+=(65532&e.getUint16(t+1,!1))>>2,t+=3,i.PackHeaders+=1,i.PackHeadersSize+=7,2==i.mpgVers&&(i.PackHeadersSize+=1),r(e,t,3)!=A)return-1;if(e.getUint8(t+3)==g){t+=4;var H=e.getUint16(t,!1);i.SystemHeaders+=1,i.SystemHeadersSize+=H+6,t+=5;var I=e.getUint8(t);t+=1,I=e.getUint8(t);for(t+=2;128==(128&e.getUint8(t));)t+=3;if(r(e,t,3)!=A)return-2;t+=0}var F=e.getUint8(t+3);t+=4;var T=e.getUint16(t,!1),j=t+2+T;if(F==p&&(i.PSMPackets+=1,i.PSMPacketsSize+=T),F>=h&y>=F){var x=F-192;if("undefined"==typeof i.Atracks[x]){i.Atracks[x]={id:x,layer:0,size:T,bitrate:0,sampling:0,packCount:1,SCR_deb:[],SCR_end:[]};for(var q=t+2;65520!=(65520&e.getUint16(q,!1))||15==(15&e.getUint16(q,!1));)q+=1;var G=15&e.getUint16(q,!1),X=e.getUint16(q+2,!1)>>4,J=4-((6&G)>>1);i.Atracks[x].layer=J;var K=(3840&X)>>8;i.Atracks[x].bitrate=_[K][J-1],K=(192&X)>>6,i.Atracks[x].sampling=V[K],K=(12&X)>>2,i.Atracks[x].channels=m[K],i.Atracks[x].SCR_deb=[s,a,d,c]}else i.Atracks[x].size+=T,i.Atracks[x].packCount+=1,i.Atracks[x].SCR_end=[s,a,d,c];for(q+=4;(r(e,q,3)!=A||e.getUint8(q+3)!=o)&&j>q;)q+=1;if(r(e,q,3)==A&&e.getUint8(q+3)==o){q+=7;var Q=e.getUint16(q,!1);i.Atracks[x].Audinfo=n(e,q+2,Q)}}else if(F>=U&&b>=F){for(var W=F-224,q=t+2,Y=t+2;r(e,Y,3)!=A||e.getUint8(Y+3)!=l&&j-4>Y;)Y+=1;if(j-4>Y){var Z=(240&e.getUint8(Y+4))>>4;if(8==Z){(4080&e.getUint16(Y+4,!1))>>4,(8&e.getUint8(Y+5))>>3,(6&e.getUint8(Y+5))>>1,(384&e.getUint16(Y+5,!1))>>7,(96&e.getUint8(Y+6))>>5,(8190&e.getUint16(Y+6,!1))>>1}}if("undefined"==typeof i.Vtracks[W]){for(;r(e,q,3)!=A||e.getUint8(q+3)!=u&&j>q;)q+=1;if(j>q){q+=4;var I=e.getUint32(q,!1),$=(4293918720&I)>>20,ee=(1048320&I)>>8,te=15&I,re=z[te],f=Math.floor(e.getUint32(q+4,!1)/16384);262143==f?f="Variable":f*=400,i.Vtracks[W]={id:W,width:$,height:ee,framerate:re,BitRate:f,size:T,packCount:1,SCR_deb:[],SCR_end:[]},i.Vtracks[W].SCR_deb=[s,a,d,c]}else q=t+2}else i.Vtracks[W].size+=T,i.Vtracks[W].packCount+=1,i.Vtracks[W].SCR_end=[s,a,d,c];if(i.Vtracks[W]&&"undefined"==typeof i.Vtracks[W].Vidinfo){for(q+=7;(r(e,q,3)!=A||e.getUint8(q+3)!=o)&&j>q;)q+=1;if(r(e,q,3)==A&&e.getUint8(q+3)==o){for(var ie=q+6;r(e,ie,3)!=A&&j>ie;)ie+=1;if(j>ie){for(var ne=ie-2;ne>q+4;ne--)if(e.getUint16(ne,!1)+ne+3==ie&&0==e.getUint8(ie-1)){var Q=e.getUint16(ne,!1);i.Vtracks[W].Vidinfo=n(e,ne+2,Q);break}"undefined"==typeof i.Vtracks[W].Vidinfo&&(i.Vtracks[W].Vidinfo="")}}}}if(F==v&&2==i.mpgVers){t+=2;var se=e.getUint8(t+2);t+=3+se;var ae=e.getUint8(t);if(ae>31&&64>ae){var de=ae-32;"undefined"==typeof i.Stracks[de]?i.Stracks[de]={id:de,bettersize:e.getUint16(t+1,!1),packCount:1,SCR_deb:[s,a,d,c],SCR_end:[]}:(i.Stracks[de].packCount+=1,i.Stracks[de].bettersize+=e.getUint16(t+1,!1),i.Stracks[de].SCR_end=[s,a,d,c])}else if(ae>127&&136>ae){var x=ae-128;if("undefined"==typeof i.Atracks[x]){for(var ce=t;r(e,ce,2)!=P&&j>ce;)ce+=1;if(j>ce){i.Atracks[x]={id:x,layer:"AC3",size:T,bitrate:0,sampling:0,packCount:1,SCR_deb:[s,a,d,c],SCR_end:[]},ce+=4;var fe=(192&e.getUint8(ce))>>6;i.Atracks[x].sampling=L[fe];var oe=63&e.getUint8(ce);i.Atracks[x].bitrate=E[oe][0];var ue=7&e.getUint8(ce+1),le=(224&e.getUint8(ce+2))>>5;i.Atracks[x].AC3Mode=O[le],7==ue&&le>1&&(ue=8),i.Atracks[x].bsMode=D[ue]}}else i.Atracks[x].size+=T,i.Atracks[x].packCount+=1,i.Atracks[x].SCR_end=[s,a,d,c]}else if(ae>159&&168>ae){var x=ae-160;if("undefined"==typeof i.Atracks[x]){var Se=16+((192&e.getUint8(t+4))>>4),ke=49152;16==(48&e.getUint8(t+4))&&(ke*=2);var ge=(15&e.getUint8(t+4))+1,pe=Se*ke*ge/4800,ve=600*pe/1024;i.Atracks[x]={id:x,layer:"LCPM",bettersize:pe,size:pe,bitrate:ve,sampling:ke,packCount:1,nbChannels:ge,SCR_deb:[s,a,d,c],SCR_end:[]}}else i.Atracks[x].bettersize+=i.Atracks[x].size,i.Atracks[x].packCount+=1,i.Atracks[x].SCR_end=[s,a,d,c]}else if(ae>135&&144>ae){var x=ae-136;if("undefined"==typeof i.Atracks[x]){for(var ce=t;r(e,ce,4)!=M&&j>ce;)ce+=1;if(j>ce){var Ce=(4032&e.getUint16(ce+7,!1))>>6,Re=(60&e.getUint8(ce+8))>>2,he=(960&e.getUint16(ce+8,!1))>>6;i.Atracks[x]={id:x,layer:"DTS",size:T,bettersize:0,bitrate:754.5,sampling:"invalid",packCount:1,SCR_deb:[s,a,d,c],SCR_end:[]},15==he?(i.Atracks[x].bitrate=754.5,i.Atracks[x].bettersize+=1005):(i.Atracks[x].bitrate=1536,i.Atracks[x].bettersize+=2012),i.Atracks[x].nbChannels=N[Ce],"invalid"!=w[Re]&&(i.Atracks[x].sampling=w[Re])}}else i.Atracks[x].size+=T,i.Atracks[x].packCount+=1,i.Atracks[x].SCR_end=[s,a,d,c],772608==i.Atracks[x].bitrate?i.Atracks[x].bettersize+=1005:i.Atracks[x].bettersize+=2012}else if(ae>143&&152>ae)var x=ae-144}if(F!=R){for(i.OthersPackets+=1,t+=2;128==(128&e.getUint8(t));)t+=1;64==(192&e.getUint8(t))&&(t+=2),t+=32==(240&e.getUint8(t))?5:48==(240&e.getUint8(t))?10:1}else 2==i.mpgVers&&(i.menu=!0);if(e.getUint8(j+3)==S)return i.ENDPackets+=1,i.SCRs.push([s,a,d,c]),-3;for(;r(e,j,3)!=A||e.getUint8(j+3)!=k&&j<e.byteLength-4;)j+=1;return j==e.ByteLength-4?-2:j}if(e.getUint8(t+3)==C){i.OthersPackets+=1;for(var T=e.getUint16(t+4,!1),j=t+6+T;r(e,j,3)!=A||e.getUint8(j+3)!=k&&j<e.byteLength-4;)j+=1;return j==e.ByteLength-4?-2:j}}function d(e,t){var n=e,o=H;i.filesize-n<H&&(o=i.filesize-n),s(o,n,function(n,s){if(n)return t(n);if(c=s.byteLength,B=e+c,f=0,i.speedy&&i.beginend)for(;r(s,f,3)!=A||s.getUint8(f+3)!=k&&f<s.byteLength-4;)f+=1;if("000001ba"!=r(s,f,4))return t("This file is not an MPG file");if(32==(240&s.getUint8(f+4)))i.mpgVers=1;else{if(64!=(192&s.getUint8(f+4)))return t("This file is not an MPG file but begin with 000001BA");i.mpgVers=2}if(1==i.mpgVers||2==i.mpgVers){var o=0;do var o=a(s,o);while(o>0&&c-I>=o&&B!=i.filesize||B==i.filesize&&-3==o||0>o)}if(i.speedy&&i.countloop++,-3==o)t(null,i);else{if(0>o)return t("error : "+o);if(f=o,e=B-c+f,B>=i.filesize){for(var u=[],l=i.Stracks.length-1;l>-1;l--)null!=i.Stracks[l]&&u.push(i.Stracks[l]);i.Stracks=u,u=[];for(var l=i.Vtracks.length-1;l>-1;l--)null!=i.Vtracks[l]&&u.push(i.Vtracks[l]);i.Vtracks=u,u=[];for(var l=i.Atracks.length-1;l>-1;l--)null!=i.Atracks[l]&&u.push(i.Atracks[l]);if(i.Atracks=u,0==i.SCRs.length)i.dureeS=(32768*i.SCR_end[1]+i.SCR_end[2]-(32768*i.SCR_deb[1]+i.SCR_deb[2]))/9e4;else{i.dureeS=(32768*i.SCRs[0][1]+i.SCRs[0][2]-(32768*i.SCR_deb[1]+i.SCR_deb[2]))/9e4;for(var l=1;l<i.SCRs.length-1;l++)i.dureeS+=(32768*i.SCRs[l][1]+i.SCRs[l][2])/9e4;i.dureeS+=(32768*i.SCR_end[1]+i.SCR_end[2])/9e4}i.dureeS=Math.round(1e3*i.dureeS)/1e3;for(var l=0;l<i.Vtracks.length;l++){if(0==i.SCRs.length)i.Vtracks[l].dureeS=(32768*i.Vtracks[l].SCR_end[1]+i.Vtracks[l].SCR_end[2]-(32768*i.Vtracks[l].SCR_deb[1]+i.Vtracks[l].SCR_deb[2]))/9e4;else{i.Vtracks[l].dureeS=(32768*i.SCRs[0][1]+i.SCRs[0][2]-(32768*i.Vtracks[l].SCR_deb[1]+i.Vtracks[l].SCR_deb[2]))/9e4;for(var S=1;S<i.SCRs.length-1;S++)i.Vtracks[l].dureeS+=(32768*i.SCRs[S][1]+i.SCRs[S][2])/9e4;i.Vtracks[l].dureeS+=(32768*i.Vtracks[l].SCR_end[1]+i.Vtracks[l].SCR_end[2])/9e4}i.Vtracks[l].dureeS=Math.round(1e3*i.Vtracks[l].dureeS)/1e3,i.Vtracks[l].dureeS<.95*i.dureeS&&(i.Vtracks[l].dureeS=i.dureeS)}for(var l=0;l<i.Atracks.length;l++){if(0==i.SCRs.length)i.Atracks[l].dureeS=(32768*i.Atracks[l].SCR_end[1]+i.Atracks[l].SCR_end[2]-(32768*i.Atracks[l].SCR_deb[1]+i.Atracks[l].SCR_deb[2]))/9e4;else{i.Atracks[l].dureeS=(32768*i.SCRs[0][1]+i.SCRs[0][2]-(32768*i.Atracks[l].SCR_deb[1]+i.Atracks[l].SCR_deb[2]))/9e4;for(var S=1;S<i.SCRs.length-1;S++)i.Atracks[l].dureeS+=(32768*i.SCRs[S][1]+i.SCRs[S][2])/9e4;i.Atracks[l].dureeS+=(32768*i.Atracks[l].SCR_end[1]+i.Atracks[l].SCR_end[2])/9e4}i.Atracks[l].dureeS=Math.round(1e3*i.Atracks[l].dureeS)/1e3}for(var l=0;l<i.Stracks.length;l++){if(0==i.SCRs.length)i.Stracks[l].dureeS=(32768*i.Stracks[l].SCR_end[1]+i.Stracks[l].SCR_end[2]-(32768*i.Stracks[l].SCR_deb[1]+i.Stracks[l].SCR_deb[2]))/9e4;else{i.Stracks[l].dureeS=(32768*i.SCRs[0][1]+i.SCRs[0][2]-(32768*i.Stracks[l].SCR_deb[1]+i.Stracks[l].SCR_deb[2]))/9e4;for(var S=1;S<i.SCRs.length-1;S++)i.Stracks[l].dureeS+=(32768*i.SCRs[S][1]+i.SCRs[S][2])/9e4;i.Stracks[l].dureeS+=(32768*i.Stracks[l].SCR_end[1]+i.Stracks[l].SCR_end[2])/9e4}i.Stracks[l].dureeS=Math.round(1e3*i.Stracks[l].dureeS)/1e3,i.Stracks[l].bitrate=8*i.Stracks[l].bettersize/i.Stracks[l].dureeS/1024}t(null,i)}else i.speedy&&i.Vtracks.length>0&&!i.beginend&&i.countloop==i.nbloop&&(e=i.filesize-10*H,i.beginend=!0),d(e,t)}})}var c,f,o=178,u=179,l=181,S=185,k=186,g=187,p=188,v=189,C=190,R=191,h=192,y=223,U=224,b=239,A="000001",_=[["?","?","?"],[32,32,32],[64,48,40],[96,56,48],[128,64,56],[160,80,64],[192,96,80],[224,112,96],[256,128,112],[288,160,128],[320,192,160],[352,224,192],[384,256,224],[416,320,256],[448,384,320]],V=[44.1,48,32,"reserved"],m=["stereo","joint_stereo","dual_channel","single_channel"],z=["forbidden",23.976,24,25,29.97,30,50,59.94,60],P="0b77",L=[48,44.1,32,"reserved"],E=[[32,96,69,64],[32,96,70,64],[40,120,87,80],[40,120,88,80],[48,144,104,96],[48,144,105,96],[56,168,121,112],[56,168,122,112],[64,192,139,128],[64,192,140,128],[80,240,174,160],[80,240,175,160],[96,288,208,192],[96,288,209,192],[112,336,243,224],[112,336,244,224],[128,384,278,256],[128,384,279,256],[160,480,348,320],[160,480,349,320],[192,576,417,384],[192,576,418,384],[224,672,487,448],[224,672,488,448],[256,768,557,512],[256,768,558,512],[320,960,696,640],[320,960,697,640],[384,1152,835,768],[384,1152,836,768],[448,1344,975,896],[448,1344,976,896],[512,1536,1114,1024],[512,1536,1115,1024],[576,1728,1253,1152],[576,1728,1254,1152],[640,1920,1393,1280],[640,1920,1394,1280],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"],["reserved"]],O=[[2,"1+1"],[1,"1/0"],[2,"2/0"],[3,"3/0"],[3,"2/1"],[4,"3/1"],[4,"2/2"],[5,"3/2"]],D=["complete main (CM)","music and effects (ME)","visually impaired (VI)","hearing impaired (HI)","dialog (D)","commentary (C)","emergency (E)","voice over (VO)","karaoke"],M="7ffe8001",w=["invalid",8,16,32,"invalid","invalid",11.025,22.05,44.1,"invalid","invalid",12,24,48,"invalid","invalid"],N=[1,2,2,2,2,3,3,4,4,5,6,6,6,7,8,8],H=262144,B=0,I=8192;i.filesize<2*i.nbloop*H&&(i.speedy=!1),d(0,function(e){e?t(e):t(null,i)})};var d=function(e){this.type=e||d.OPEN_URI,this.size=null,this.file=null};if(d.OPEN_FILE=1,d.OPEN_URI=2,d.OPEN_LOCAL=3,"function"==typeof require)var c=require("fs");if(d.prototype.open=function(e,t){this.file=e;var r=this;switch(this.type){case d.OPEN_LOCAL:c.stat(this.file,function(e,i){return e?t(e):(r.size=i.size,void c.open(r.file,"r",function(e,i){return e?t(e):(r.fd=i,void t())}))});break;case d.OPEN_FILE:this.size=this.file.size,t();break;default:this.ajax({uri:this.file,type:"HEAD"},function(e,i,n){return e?t(e):(r.size=parseInt(n.getResponseHeader("Content-Length")),void t())})}},d.prototype.close=function(){this.type===d.OPEN_LOCAL&&c.close(this.fd)},d.prototype.read=function(e,t,r){"function"==typeof t&&(r=t,t=0),this.type===d.OPEN_LOCAL?this.readLocal(e,t,r):this.type===d.OPEN_FILE?this.readFile(e,t,r):this.readUri(e,t,r)},d.prototype.readBlob=function(e,t,r,i){"function"==typeof t?(i=t,t=0):"function"==typeof r&&(i=r,r="application/octet-stream"),this.read(e,t,function(e,t){return e?void i(e):void i(null,new Blob([t],{type:r}))})},d.prototype.readLocal=function(e,t,r){var i=new Buffer(e);c.read(this.fd,i,0,e,t,function(e,t,i){if(e)return r(e);for(var n=new ArrayBuffer(i.length),s=new Uint8Array(n),a=0;a<i.length;a++)s[a]=i[a];r(null,n)})},d.prototype.ajax=function(e,t){var r={type:"GET",uri:null,responseType:"text"};"string"==typeof e&&(e={uri:e});for(var i in e)r[i]=e[i];var n=new XMLHttpRequest;n.onreadystatechange=function(){return 4===n.readyState?200!==n.status&&206!==n.status?t("Received non-200/206 response ("+n.status+")"):void t(null,n.response,n):void 0},n.responseType=r.responseType,n.open(r.type,r.uri,!0),r.range&&(r.range=[].concat(r.range),2===r.range.length?n.setRequestHeader("Range","bytes="+r.range[0]+"-"+r.range[1]):n.setRequestHeader("Range","bytes="+r.range[0])),n.send()},d.prototype.readUri=function(e,t,r){this.ajax({uri:this.file,type:"GET",responseType:"arraybuffer",range:[t,t+e-1]},function(e,t){return e?r(e):r(null,t)})},d.prototype.readFile=function(e,t,r){if("undefined"==typeof FileReader){var i=this.file.slice(t,t+e),n=new FileReaderSync;r(null,n.readAsArrayBuffer(i))}else{var i=this.file.slice(t,t+e),n=new FileReader;n.onload=function(e){r(null,e.target.result)},n.readAsArrayBuffer(i)}},"string"==typeof n.type)switch(n.type){case"file":n.type=d.OPEN_FILE;break;case"local":n.type=d.OPEN_LOCAL;break;default:n.type=d.OPEN_URI}var f=new d(n.type);f.open(n.file,function(e){return e?cb("Could not open specified file"):void a.parse(f,function(e,t){r(e,t)})})};"undefined"!=typeof module&&module.exports?module.exports=mpg:"function"==typeof define&&define.amd&&define("mpg",[],function(){return mpg});